################################################################################
#
# * This file is part of SplashSync Project.
# *
# * Copyright (C) Splash Sync <www.splashsync.com>
# *
# * This program is distributed in the hope that it will be useful,
# * but WITHOUT ANY WARRANTY; without even the implied warranty of
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# *
# * For the full copyright and license information, please view the LICENSE
# * file that was distributed with this source code.
# *
# * @author Bernard Paquier <contact@splashsync.com>
#
################################################################################

################################################################################
# Test Jobs
jobs:
    include:
        # Akeneo V2.0 Branch       
        - php: 7.1
          env: AKENEO_VERSION="2.0"
        # Akeneo V2.1 Branch       
        - php: 7.1
          env: AKENEO_VERSION="2.1"

################################################################################
# Install Update Composer, Configure Env. 
before_install:
    # Update composer
    - composer self-update
    # Install Yarn
    - yarn 
    # Configure PHP  
    - phpenv config-rm xdebug.ini
    - phpenv config-add build/x_memory.ini
    - php -ini | grep memory_limit  
    - if [[ "$(php -v | grep 'PHP 7')" ]]; then echo yes | pecl install apcu; fi
    - if [[ "$(php -v | grep 'PHP 7')" ]]; then echo yes | pecl install imagick; fi
    # Create database, schema and fixtures
    - mysql -e 'CREATE DATABASE IF NOT EXISTS akeneo;'
  
################################################################################
# Install composer dependencies,
install:   
    - echo "Configuring Akeneo"
    - cp build/parameters.yml.dist app/config/parameters.yml

    - echo "Install Akeneo & Splash Bundles"
    - composer require akeneo/pim-community-dev $AKENEO_VERSION --prefer-dist --no-suggest  

    - echo "Configuring Akeneo"
    - cp    vendor/akeneo/pim-community-dev/app/config/routing.yml app/config/routing.yml
    - cp    vendor/akeneo/pim-community-dev/app/PimRequirements.php app/PimRequirements.php
    - cat   build/routing_splash.yml   >> app/config/routing.yml
    - echo  "" > vendor/akeneo/pim-community-dev/src/Pim/Bundle/InstallerBundle/Resources/fixtures/icecat_demo_dev/products.csv
    
    - echo "Install Akeneo"
    - php bin/console pim:installer:assets  --symlink --clean --env=test --no-interaction --no-debug
    - php bin/console pim:install --force   --symlink --clean --env=test --no-interaction --no-debug
    - php bin/console debug:config splash --env=test --no-interaction --no-debug

    - echo "Start Web Srever"
    - php bin/console server:start --env=test

# Run script
script:
  - phpunit
#  - phpunit

################################################################################
# Project Config
language: php
os: linux
services:
  - mysql
  - elasticsearch
cache:
    yarn: true
    directories:
        - $HOME/.composer/cache/files
        - $HOME/.cache/pip
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

# After a build, send email notification with the build results
notifications:
  email:         
    on_success: never # default: change
    on_failure: never # default: always
